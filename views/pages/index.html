<!doctype html>
<html>
  <head>
    <title>Chat</title>
    <style>
        .chat-container {
            width: 100%;
            height: 100%;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            box-shadow: 0px 0px 6px 1px #00000040;
            position: absolute;
            top: 0px;
            right: 0px;
            bottom: 0px;
            left: 0px;
            overflow: hidden;
            border: 0px;
            padding: 0px;
            background: transparent;
        }
        #chat-header{
            width: 100%;
            background: #4CAF50;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }
        #chat-header #welcome-message{
            margin: 0px;
            color: white;
            text-align: center;
            padding: 15px;
        }
        #chat-content{
            padding:10px;
            overflow-y: scroll;
        }
        .chat-box {
            min-height: 40px;
            display: inline-block;
            width: 100%;
            margin-bottom: 5px;
        }

        #nm {
            margin: 0px;
            font-size: 14px;
            display: block;
            font-weight: bold;
        }
        #ms {
            margin: 0px;
            background: #efefef;
            border-radius: 5px;
            padding: 10px;
            border: 1px solid #d8d8d8;
            display: block;
            max-width: 80%;
        }
        #ms-dt{
            margin: 0px;
            font-size: 12px;
            display: block;
            text-align: right;
            color: grey;
        }
        #av-box {
            height: 40px;
            width: 13%;
            display: block;
            position: relative;
            top: 8px;
        }
        #av-box img{height:100%;}

        #conv-t-area{
             width: 100%;
            height: 100px;
            padding: 5px;
            display: block;
        }
        #conv-t-area textarea{
                width: 100%;
                height: 70%;
        }
        #conv-t-area button{
            width:100%;
        }
        .r-box #av-box{
          float:right;
          text-align: center;
        }
        .r-box #ms{
          float:right;
        }
        
        .l-box #av-box{
          float:left;
          text-align: center;
        }
        .l-box #ms{
          float:left;
        }
    </style>
  </head>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
<script>
  (function(){
       var element
  })();
</script>
<script>

  function startUserChat(socket,client_id){
        console.log("start chat");
        socket.emit('startUserChat', client_id);
    }

  function sendMessage(socket,client_id,msg){
        console.log("send message");
        var data = {user_id:client_id,message:msg,username:"artiom",email:"artiom@mail.com"};
        socket.emit('sendMessage', data);
    } 

  $(function () {
    var socket = io();
    
    socket.on('chat message', function(msg){
      $('#messages').append($('<li>').text(msg));
    });
    socket.on('output', function(msg){
      for( var i = 0; i < msg.length ; i++){
         $('#messages').append($('<li>').text(msg[i].message));  
      }
      
    });
  });

  $(document).ready(function(){
    var socket = io();
    startUserChat(socket,"10");

    socket.on('renderChat', function(data){
      console.log(data);
        var user_id = "10";
        var welcome_message = "Hello User";
        var chat = '<div class="chat-container" data-id="'+user_id+'" ><div id="chat-header"><p id="welcome-message">'+welcome_message+'</p></div><div id="chat-content">';
        if(data.length > 0){
          $.each(data[0].messages,function(index,value){                  
                 var user_id = value.user_id;
                 var username = value.username;
                 var email = value.email;
                 var created = value.creation_time;
                 var type = value.type;
                 var message = value.message;
                 if(type=="support"){
                   var box_class = "r-box";
                   var avatar = "https://1.img-dpreview.com/files/p/TC1x1S40~avatars/8130397526/1/avatar.jpg";
                 }else if(type=="user"){
                   var box_class = "l-box";
                   var avatar = "https://d2giyh01gjb6fi.cloudfront.net/useravatar/0001/67/thumb_66160_useravatar_small.jpeg";
                 }
                 var div = '<div class="chat-box '+box_class+'">';
                 div+='<span id="av-box"><img src="'+avatar+'"></span>';
                 div+='<p id="ms"><span id="nm">'+username+'</span><span id="ms-text">'+message+'</span></p>';
                 div+='</div>';
                 chat+=div;
          });
        }
        chat+='</div><div id="conv-t-area"><textarea name="conv-t" placeholder="Type your message here"></textarea>';
        //If data dont have client id it means he doesnt exists
        chat+='<button id="chat-submit">Send</button></div></div>';
        $("body").prepend(chat);

          $('#chat-submit').click(function(){
              var msg = $("#conv-t-area textarea").val();
              var client_id = $('.chat-container').attr("data-id");
              $("#conv-t-area textarea").val("");
              sendMessage(socket,client_id,msg);
          });

      });


  });
</script>
  <body>
    
  </body>
</html>
